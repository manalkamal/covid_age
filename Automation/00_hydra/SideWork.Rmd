---
title: "Side Work of COVerAGE- appending Data or collecting missing data etc.."
author: "Manal Kamal"
date: "_07 July, 2022 & last compiled on `r format(Sys.time(), '%d %B, %Y')`_" 
output:
  html_document:
    theme: flatly
    df_print: paged
    highlight: tango
    toc: true
    toc_float: true
    smooth_scroll: true 
    number_sections: true
editor_options: 
  markdown: 
    wrap: 72
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(
	eval = FALSE,
	message = FALSE,
	warning = FALSE,
	include = FALSE
)
#{.tabset .tabset-fade .tabset-pills}
#{.unnumbered}
```

*Brief*: This file is intended to do the side work that is not necessarily required to add in the automated scripts; for example: adding missing data for a certain period, download excel/ pdf files from website, etc. 

Since this work is related to the already existing datasets and in order to keep things documented, I preferred to keep this work on the side of the existing 'automated' scripts. 


## ======= read common lines first ======


```{r}

library(here)
library(purrr)  
library(rvest)
source(here("Automation/00_Functions_automation.R"))

# assigning Drive credentials in the case the script is verified manually  
if (!"email" %in% ls()){
  email <- "mumanal.k@gmail.com"
}


# Drive credentials
drive_auth(email = Sys.getenv("email"))
gs4_auth(email = Sys.getenv("email"))

```

## Canada 

##├ Date: 16.12.2022
Problem: Missing Cases and deaths data since 20.02.2021; so collected PDFs from Way Back Machhine manually and copied the cases/ deaths data by age for the past two years. here is just to wrangle and append to the database sheet in the drive. 


& so to note, that there are missing reports/ data 

```{r}

at_rubric <- get_input_rubric() %>% 
  dplyr::filter(Short == "CA")
ss_i   <- at_rubric %>% dplyr::pull(Sheet)
ss_db  <- at_rubric %>% dplyr::pull(Source)


db_drive <- read_sheet(ss = ss_i, sheet = "database") %>% 
  sort_input_data() %>% 
  mutate(Age = as.character(Age),
         AgeInt = as.character(AgeInt))


Cases <- read_excel("N:/COVerAGE-DB/Automation/Hydra/Data_sources/Canada/CanadaDataFromPDFs.xlsx", 
                    sheet = "Cases") %>% 
  select(Date, Age, AgeInt, b, m, f, UNK) %>% 
  mutate(Age = as.character(Age),
         AgeInt = as.character(AgeInt),
         b = as.numeric(b),
         m = as.numeric(m),
         f = as.numeric(f),
         UNK = as.numeric(UNK))


Deaths <- read_excel("N:/COVerAGE-DB/Automation/Hydra/Data_sources/Canada/CanadaDataFromPDFs.xlsx", 
                     sheet = "Deaths") %>% 
  select(Date, Age, AgeInt, b, m, f, UNK) %>% 
  mutate(Age = as.character(Age),
         AgeInt = as.character(AgeInt),
         b = as.numeric(b),
         m = as.numeric(m),
         f = as.numeric(f),
         UNK = as.numeric(UNK))


processed_data <- bind_rows("Cases" = Cases,
                            "Deaths" = Deaths,
                            .id = "Measure") %>% 
  pivot_longer(cols = c("b", "m", "f", "UNK"),
               names_to = "Sex",
               values_to = "Value") %>% 
  mutate(Country = "Canada",
         Code = "CA",
         Region = "All",
         Metric = "Count")


data_out <- bind_rows(db_drive, processed_data) %>% 
  filter(!is.na(Date)) |> 
  unique() %>% 
  sort_input_data()



sheet_write(data_out, ss = ss_i, sheet = "database")


```



## Zimbabwe 

##├ Date: 20.06.2023


```{r}

at_rubric <- get_input_rubric() %>% 
  dplyr::filter(Short == "ZW")
ss_i   <- at_rubric %>% dplyr::pull(Sheet)
ss_db  <- at_rubric %>% dplyr::pull(Source)


db_drive <- read_sheet(ss = ss_i, sheet = "database") %>% 
  unique() %>% 
  sort_input_data()

sheet_write(db_drive, ss = ss_i, sheet = "database")

```



## Germany 

##├ Date: 15.06.2023


```{r}


Germany_vaccine <- readRDS("N:/COVerAGE-DB/Automation/Hydra/Germany_vaccine.rds")

germany_out <- Germany_vaccine |> 
  filter(Region == "All") 

Germany_vaccine |> write.csv("Germany_raw_cum.csv")


# 
# harmonized <- data.table::fread("N:/COVerAGE-DB/Data/Output_5_internal.csv")
# 
# harmonized_ger <- harmonized |> 
#   filter(str_detect(Measure, "Vacc"))

```







## Ecuador 

##├ Date: 31.05.2023


```{r}

files_dest <- "N:/COVerAGE-DB/Automation/Hydra/Data_sources/Ecuador/"

url_main <- "https://www.gestionderiesgos.gob.ec/informes-de-situacion-covid-19-desde-el-13-de-marzo-del-2020/"

pdfs_dataframe <- data.frame(links = read_html(url_main) %>% 
             html_nodes("a ") %>% 
             html_attr('href')) |> 
  filter(str_detect(links, ".pdf")) |> 
  mutate(name = str_remove(links, "https://www.gestionderiesgos.gob.ec/wp-content/uploads/"),
         name = str_remove(name, "\\d+/\\d+/"))


files_in_dataframe <- pdfs_dataframe %>%
  unique() |> 
  mutate(number = row_number(),
         destinations = paste0(files_dest, name)) 


for(i in seq_along(files_in_dataframe$links)){
  if(class(try(download.file(files_in_dataframe$links[i],
                             destfile = files_in_dataframe$destinations[i],
                             mode="wb"),
               silent = TRUE)) == "try-error"){
    print(paste("No file for:", i))
  next 
    print(paste("downnloading:", i))
  }
}



# files_in_dataframe %>% 
#   {map2(.$links, .$destinations, ~ download.file(url = .x, destfile = .y, mode="wb"))}

```



##├ Date: 07.07.2023

```{r}

at_rubric <- get_input_rubric() %>% 
  dplyr::filter(Country == "Ecuador")
ss_i   <- at_rubric %>% dplyr::pull(Sheet)
ss_db  <- at_rubric %>% dplyr::pull(Source)


db_drive <- read_sheet(ss = ss_i, sheet = "database") %>% 
  unique() %>% 
  sort_input_data()

sheet_write(db_drive, ss = ss_i, sheet = "database")


db_drive |> 
  mutate(Date = dmy(Date)) |> 
  filter(Measure == "Cases", Metric == "Count") |> 
  ggplot(aes(x = Date, y = Value)) +
  geom_point() +
  facet_wrap(~Age, scales = "free_y")



```



## Burkina-Faso 

##├ Date: 30.05.2023


```{r}

library(rvest)

files_dest <- "N:/COVerAGE-DB/Automation/Hydra/Data_sources/Burkina-Faso/"

url_main <- "https://www.humanitarianresponse.info/en/operations/burkina-faso/documents/themes/covid-19"

page_number <- 1:11

base_url <- "https://www.humanitarianresponse.info/en/operations/burkina-faso/documents/themes/covid-19?page="


missing_files <- data.frame(base = rep(base_url), 
                            times = page_number) %>% 
  mutate(url = paste0(base, times)) |> 
  dplyr::pull(url)


extract_pdfs <- function(url_main){
  
  data.frame(links = read_html(url_main) %>% 
             html_nodes("a ") %>% 
             html_attr('href')) |> 
  filter(str_detect(links, ".pdf"))
}


pdfs_dataframe <- map_dfr(missing_files, extract_pdfs)


files_in_dataframe <- pdfs_dataframe %>%
  mutate(number = row_number(),
         destinations = paste0(files_dest, "BF-", number, ".pdf")) 

files_in_dataframe %>% 
  {map2(.$links, .$destinations, ~ download.file(url = .x, destfile = .y, mode="wb"))}

```


##├ Date: 12.06.2023


```{r}

at_rubric <- get_input_rubric() %>% 
  dplyr::filter(Short == "BF")
ss_i   <- at_rubric %>% dplyr::pull(Sheet)
ss_db  <- at_rubric %>% dplyr::pull(Source)


db_drive |> 
  mutate(Date = dmy(Date)) |> count(Date) |> View()

db_drive <- read_sheet(ss = ss_i, sheet = "database") %>% 
  unique() %>% 
  sort_input_data()



sheet_write(db_drive, ss = ss_i, sheet = "database")

```




## KENYA 


```{r}


at_rubric <- get_input_rubric() %>% 
  dplyr::filter(Short == "KE")
ss_i   <- at_rubric %>% dplyr::pull(Sheet)
ss_db  <- at_rubric %>% dplyr::pull(Source)


db_drive <- read_sheet(ss = ss_i, sheet = "database") %>% 
  unique() %>% 
  sort_input_data()



sheet_write(db_drive, ss = ss_i, sheet = "database")


```






## NEPAL 


```{r}


at_rubric <- get_input_rubric() %>% 
  dplyr::filter(Short == "NP")
ss_i   <- at_rubric %>% dplyr::pull(Sheet)
ss_db  <- at_rubric %>% dplyr::pull(Source)


db_drive <- read_sheet(ss = ss_i, sheet = "database") %>% 
  sort_input_data()


deaths_prep_tot <- db_drive %>% 
  mutate(Date = dmy(Date)) %>% 
  filter(Measure == "Deaths",
         Age != "TOT") %>% 
  distinct(Country, Region, Code, Measure, Date) %>% 
  mutate(Sex = "b",
         Age = "TOT", 
         AgeInt = NA_character_, 
         Metric = "Count",
         Value = NA_character_,
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, Age, AgeInt, Metric, Measure, Value)



sheet_write(deaths_prep_tot, ss = ss_i, sheet = "deaths_TOT")


```



## CDC USA nationwide data 

##├ Date: 27.10.2022

issue: lost python downloaded files from >09.06.2022 until <21.10.2022 

Why I use these data to fill in the gaps? because as per CDC website, this is the data used for the graphs we are automating data from. 

## these data are updated; in case we may shift to it completely instead of python. 

I use this data for this purpose:

https://data.cdc.gov/Case-Surveillance/United-States-COVID-19-Cases-and-Deaths-by-State-o/9mfq-cb36/data 

Since we collect the 'confirmed' cases and deaths counts as published here, I will stick to this for consistency 

https://covid.cdc.gov/covid-data-tracker/#demographics 

## UNFORTUNATELY ALL THESE LINKS DOES NOT HAVE AGE GROUPS :( stopped for now. 

##├ Date: 12.12.2022

I use the CDC linelist data to get these missing weeks .. 

```{r}

source(here::here("Automation/00_Functions_automation.R"))

library(dplyr)
library(lubridate)
#install.packages("arrow")
library(arrow)

# assigning Drive credentials in the case the script is verified manually  
if (!"email" %in% ls()){
  email <- "maxi.s.kniffka@gmail.com"
  email <- "mumanal.k@gmail.com"
}

# Drive credentials
drive_auth(email = Sys.getenv("email"))
gs4_auth(email = Sys.getenv("email"))


dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"
dir_k <- "K:/CDC_Covid/"

ctr          <- "USA_All" # it's a placeholder
dir_n_source <- "N:/COVerAGE-DB/Automation/CDC"
dir_n        <- "N:/COVerAGE-DB/Automation/Hydra/"


DataArchive <- read_rds(paste0(dir_n, ctr, ".rds"))

cdc_surveillance <- read.csv("https://data.cdc.gov/resource/n8mc-b4w4.csv")



# folder name, this changes 

folder <- "covid_case_restricted_detailed-master_01_12_2022" 




# Read in files names 

files_list <- list.files(
  path= paste0(dir_k, folder),
  pattern = ".parquet",
  full.names = TRUE)


read_par <- function(file_name){
  read_parquet(file_name,
               col_select = c("cdc_case_earliest_dt", "sex", "age_group", "res_state"))
}

## After reading, validate the number of rows as per mentioneD in GitHub repo
  
raw_data <- files_list %>% 
  map_dfr(read_par)

## PROCESSING 

processed_data <-
  raw_data %>%
  select(Date = cdc_case_earliest_dt, 
         Sex = sex, 
         Age = age_group)%>%
  mutate(Sex =  case_when(is.na(Sex) ~ "UNK",
                          Sex == "NA" ~ "UNK",
                        Sex== "Unknown" ~ "UNK",
                        Sex== "Missing" ~ "UNK",
                        Sex== "Other" ~ "UNK",
                        Sex== "Male" ~ "m",
                        Sex== "Female"~"f",
                        TRUE ~ as.character(Sex)),
         Age = case_when (is.na(Age) ~ "UNK",
                         Age== "Unknown" ~" UNK",
                         TRUE~ as.character(Age)))%>%
  group_by(Date, Sex, Age) %>% 
  summarize(Value = n(), .groups = "drop")%>%
  tidyr::complete(Date, Sex, Age, fill = list(Value = 0)) %>% 
  arrange(Sex, Age, Date) %>% 
  group_by(Sex, Age) %>% 
  mutate(Value = cumsum(Value)) %>% 
  ungroup()%>%
  mutate(Age = recode(Age, 
                  `0 - 9 Years`="0",
                  `10 - 19 Years`="10",
                  `20 - 29 Years`="20",
                  `30 - 39 Years`="30",
                  `40 - 49 Years`="40",
                  `50 - 59 Years`="50",
                  `60 - 69 Years`="60",
                  `70 - 79 Years`="70",
                  `80+ Years`="80",
                  `Missing`="UNK",
                  `NA`="UNK")) %>% 
  group_by(Date, Age, Sex) %>% 
  summarise(Value = sum(Value)) %>% 
  ungroup()




Out <- processed_data %>% 
  mutate(AgeInt = case_when(
         Age == "80" ~ 25L,
         Age == "UNK" ~ NA_integer_,
         TRUE ~ 10L),
    Measure = "Cases",
    Metric = "Count",
    Country = "USA",
    Date = ymd(Date),
    Date = ddmmyyyy(Date),
    Code= "US",
    Region = "All") %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) %>% 
  sort_input_data()


out= rbind(DataArchive, Out)%>%
  sort_input_data()


write_rds(out, paste0(dir_n, ctr, ".rds"))

```





# Vietnam- 

minor issue:

NA character (seems) in Age-

```{r}

out <- Vietnam %>% 
  mutate(Age = as.integer(Age),
         Age = case_when(is.na(Age) ~ "UNK",
                         TRUE ~ as.character(Age)),
         AgeInt = case_when(Age == "UNK" ~ NA_integer_,
                            TRUE ~ AgeInt)) 

write_rds(out, paste0(dir_n, ctr, ".rds"))


```


# India- Vaccination

Checking if 2020-2021 data are one-dose & two-doses and makes sense with 2022 data 


```{r}

# info country and N drive address
ctr          <- "IndiaVax" # it's a placeholder
dir_n        <- "N:/COVerAGE-DB/Automation/Hydra/"
data_source <- paste0(dir_n, "Data_sources/India/")

## These data I am not sure about; not sure if 'doses administered' are 'Vaccination1' and 'fully vaccinated' are 'Vaccination2'.
## Given the context and the time frame, it seems so, but I could not find definitions. 

vax <- read_csv("http://data.covid19india.org/csv/latest/cowin_vaccine_data_statewise.csv")

dataarchived <- read_rds(paste0(dir_n, ctr, ".rds"))


vax_processed <- vax %>% 
  select(Date = `Updated On`,
         Region = State,
         Vaccinations = `Total Doses Administered`,
         Vaccinations1_18 = `18-44 Years (Doses Administered)`,
         Vaccinations1_45 = `45-60 Years (Doses Administered)`,
         Vaccinations1_60 = `60+ Years (Doses Administered)`,
         Vaccinations2_18 = `18-44 Years (Individuals Vaccinated)`,
         Vaccinations2_45 = `45-60 Years (Individuals Vaccinated)`,
         Vaccinations2_60 = `60+ Years (Individuals Vaccinated)`) %>% 
  mutate(Date = dmy(Date)) %>% 
  pivot_longer(cols = -c(Region, Date),
               names_to = c("Measure", "Age"),
               names_sep = "_",
               values_to = "Value") %>% 
  filter(!is.na(Value)) %>% 
  mutate(Value = as.numeric(Value),
         Age = case_when(Measure == "Vaccinations" ~ "TOT",
                         TRUE ~ Age),
         Country = "India",
         Sex = "b",
         Metric = "Count",
         Code = case_when(
           Region == "India" ~ "IN",
           Region == "A & N Islands" ~ "IN-AN",
           Region == "Andhra Pradesh" ~ "IN-AP",
           Region == "Arunachal Pradesh" ~ "IN-AR",
           Region == "Assam" ~ "IN-AS",
           Region == "Bihar" ~ "IN-BR",
           Region == "Chandigarh" ~ "IN-CH",
           Region == "Chhattisgarh" ~ "IN-CT",
           Region == "Delhi" ~ "IN-DL",
           Region == "Daman & Diu" ~ "IN-DD",
           Region == "Dadra & Nagar Haveli" ~ "IN-DN",
           Region == "Goa" ~ "IN-GA",
           Region == "Gujarat" ~ "IN-GJ",
           Region == "Haryana" ~ "IN-HR",
           Region == "Himachal Pradesh" ~ "IN-HP",
           Region == "Jammu & Kashmir" ~ "IN-JK",
           Region == "Jharkhand" ~ "IN-JH",
           Region == "Karnataka" ~ "IN-KA",
           Region == "Kerala" ~ "IN-KL",
           Region == "Ladakh" ~ "IN-LA",
           Region == "Lakshadweep" ~ "IN-LD",
           Region == "Madhya Pradesh" ~ "IN-MP",
           Region == "Maharashtra" ~ "IN-MH",
           Region == "Manipur" ~ "IN-MN",
           Region == "Meghalaya" ~ "IN-ML",
           Region == "Mizoram" ~ "IN-MZ",
           Region == "Nagaland" ~ "IN-NL",
           Region == "Odisha" ~ "IN-OR",
           Region == "Puducherry" ~ "IN-PY",
           Region == "Punjab" ~ "IN-PB",
           Region == "Rajasthan" ~ "IN-RJ",
           Region == "Sikkim" ~ "IN-SK",
           Region == "Tamil Nadu" ~ "IN-TN",
           Region == "Telangana" ~ "IN-TG",
           Region == "Tripura" ~ "IN-TR",
           Region == "Uttar Pradesh" ~ "IN-UP",
           Region == "Uttarakhand" ~ "IN-UT",
           Region == "West Bengal" ~ "IN-WB",
           TRUE ~ NA_character_
         ),
         AgeInt = case_when(Age == "18" ~ 27L,
                            Age == "45" ~ 15L,
                            Age == "60" ~ 45L,
                            Age == "TOT" ~ NA_integer_),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, Age, AgeInt, Metric, Measure, Value)

all_check <- bind_rows(dataarchived, vax_processed) %>% 
  sort_input_data() %>% 
  mutate(Date = dmy(Date)) 


all_check %>% 
  filter(Date == "2021-10-31") %>% 
  bind_rows(all_check %>% filter(Date == "2022-05-01")) %>%
  filter(Region == "Delhi") %>% 
  View()


```



# Gambia 



* to read from input files in Google Drive

```{r}


at_rubric <- get_input_rubric() %>% 
  dplyr::filter(Short == "GM")
ss_i   <- at_rubric %>% dplyr::pull(Sheet)
ss_db  <- at_rubric %>% dplyr::pull(Source)


db_drive <- read_sheet(ss = ss_i, sheet = "database")

data <- db_drive %>% 
 sort_input_data()

data %>% 
  mutate(Date = dmy(Date)) %>% 
  arrange(Date) %>% 
  filter(Date >= "2021-02-21") %>% 
  ggplot(aes(x = Date, y = Value, color = Age)) +
  geom_point() +
  facet_wrap(~Sex)
  


sheet_write(data, ss = ss_i, sheet = "database")


```



# Austria
##├ Date: 31.01.2023

```{r}

# info country and N drive address
ctr <- "Austria"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"

DataArchived <- readRDS("N:/COVerAGE-DB/Automation/Hydra/Austria.rds")
files_source <- paste0(dir_n, "Data_sources/", ctr, "/MissingData-15122021-25072022/")

files_download <- paste0(dir_n, "Data_sourrces/", ctr, "/MissingData-Trial/")

# https://info.gesundheitsministerium.at/data/archiv/COVID19_vaccination_doses_agegroups_v202206_20220629.csv

base_url <- "https://info.gesundheitsministerium.at/data/archiv/COVID19_vaccination_doses_agegroups_v202206_"
base_url2 <- "https://info.gesundheitsministerium.at/data/archiv/COVID19_vaccination_agegroups_v202210_"

seq_dates <- format(seq(from = as.Date("2021/12/15"), to = as.Date("2022/07/26"), by = "1 days"), "%Y%m%d")

missing_files <- data.frame(base = rep(base_url, 
                                  times = length(seq_dates)),
                       date = seq_dates) %>% 
  mutate(url = paste0(base, date, ".csv"),
         date = ymd(date),
         destinations = paste0(files_source, "Austria_vaccine", date, ".csv"))



# missing_files %>% 
#   {map2(.$url, .$destinations, ~ download.file(url = .x, destfile = .y, mode="wb"))}



for(i in seq_along(missing_files$url)){
  if(class(try(download.file(missing_files$url[i],
                             destfile = missing_files$destinations[i],
                             mode="wb"),
               silent = TRUE)) == "try-error"){
    print(paste("No file for:", i))
  next 
    print(paste("downnloading:", i))
  }
}


vax.list <-list.files(
  path= files_source,
  pattern = ".csv",
  full.names = TRUE)

raw_data <- vax.list %>% 
  map_dfr(read.csv2)


# files_in_dataframe <- data.frame(path = vax.list) %>% 
#   mutate(Date = str_extract(path, "\\d+-\\d+-\\d+")) %>% 
#   {map2_dfr(.$path, .$Date, function(x,y) read.csv2(x) %>% mutate(Date=y))}



processed_data <- raw_data %>% 
  select(Date = 1, 
         state_id, 
         Region = state_name, 
         Age = age_group, 
         Sex = gender, 
         Measure = dose_number,
         Value = doses_administered_cumulative) %>% 
  mutate(Date = ymd(str_sub(Date, 1, 10)),
         Age = recode(Age,
                      "00-11" = "0",
                      "12-14" = "12",
                      "15-24"= "15",
                      "25-34" = "25",
                      "35-44" = "35",
                      "45-54" = "45",
                      "55-64" = "55",
                      "65-74" = "65",
                      "75-84" = "75",
                      "85+" = "85",
                      "NotAssigned" = "UNK"),
         Sex = recode(Sex,
                      "Male" = "m",
                      "Female" = "f",
                      "NonBinary" = "NonBinary",
                      "NotAssigned" = "UNK"),
         Measure = paste0("Vaccination", Measure),
         Region= recode(Region,
                        "NoState"= "UNK")) %>% 
  group_by(Date, Age, Sex, state_id, Region, Measure) %>% 
  summarize(Value = sum(Value)) %>% 
  ungroup() %>% 
  distinct(Date, Age, Sex, Region, state_id,
           Measure, Value) %>% 
  mutate(Country = "Austria",
         Metric = "Count",
         Date = ddmmyyyy(Date),
         Code = paste0(ifelse(state_id < 10, paste0("AT-", state_id), "AT")),
         AgeInt = case_when(Age == "0" ~  12L,
                            Age == "12" ~ 3L,
                            Age == "85" ~ 20L,
                            #Age == "TOT" ~ "",
                            Age == "UNK" ~ NA_integer_,
                            TRUE ~ 10L),
         Code = case_when(Region == "UNK" ~ "AT-UNK+",
                          TRUE ~ Code)) %>% 
  mutate(Region = case_when(
    Region == "Ã–sterreich" ~ "All",
    Region == "KÃ¤rnten" ~ "Kärnten",
    Region == "NiederÃ¶sterreich" ~ "Niederöstereich",
    Region == "OberÃ¶sterreich" ~ "Oberösterreich",
    TRUE ~ Region),
  Measure = case_when(
    Measure == "Vaccination5+" ~ "Vaccination5",
    TRUE ~ Measure)) %>% 
  select(Country, Region, Code, Date, Sex, Age, AgeInt, Metric, Measure, Value) %>% 
  sort_input_data()


all_out <- DataArchived %>% 
  bind_rows(processed_data) %>% 
  unique() %>% 
  sort_input_data()

write_rds(all_out, paste0(dir_n, ctr, ".rds"))

```


##├ Date: 23.05.2023

Austria Vaccination data has duplicates in 20.11.2022, so by inspection turns out that the highest value is the correct one, based on revieiwng the preeceding date data values, 

here we do the appropriate handling:


```{r}

# info country and N drive address
ctr <- "Austria"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"

DataArchived <- readRDS("N:/COVerAGE-DB/Automation/Hydra/Austria.rds")

vax_data <- DataArchived |> 
  filter(str_detect(Measure, "Vacc"))

## The following is to add at the end:

epi_data <- DataArchived |> 
  filter(!str_detect(Measure, "Vacc"))

vax_data_add <- vax_data |> 
  filter(Date != "20.11.2022")

vacc_duplicated <- vax_data |> 
  filter(Date == "20.11.2022") |> 
  group_by(Region, Sex, Age, AgeInt, Measure) |> 
  filter(Value == max(Value))
  

out_all_again <- vacc_duplicated |> 
  bind_rows(vax_data_add) |> 
  bind_rows(epi_data) |> 
  sort_input_data()


write_rds(out_all_again, paste0(dir_n, ctr, ".rds"))

```


##├ Date: 26.05.2023

Austria changed the path of the files, so we lost May 2023 data in the process. To download from the archive; 

PS.: This works along with Austria.R script for adjustments in the code and binding the archived data with the missing Vax data.

```{r}

dir_source_download <- "N:/COVerAGE-DB/Automation/Hydra/Data_sources/Austria/AustriaVaxMissingMay2023"

vacc_day <- read.csv2("https://opendata.sozialversicherung.at/eimpfpass/COVID19_vaccination_agegroups_v202210.csv")

seq_dates <- format(seq(from = as.Date("2020/12/27"), to = today(), by = "1 days"), "%Y%m%d")

#seq_dates <- format(seq(from = as.Date("2021/01/03"), to = as.Date("2022/01/31"), by = "1 days"), "%Y%m%d")

base_url <- "https://opendata.sozialversicherung.at/eimpfpass/archiv/COVID19_vaccination_agegroups_v202210_"

days_df <- data.frame(base = rep(base_url, 
                                  times = length(seq_dates)),
                       date = seq_dates) %>% 
  mutate(url = paste0(base, date, ".csv"),
         date = ymd(date),
         destinations = paste0(dir_source_download, "/Austria_Age_vaccine", date, ".csv"))



for(i in seq_along(days_df$url)){
  if(class(try(download.file(days_df$url[i],
                             destfile = days_df$destinations[i],
                             mode="wb"),
               silent = TRUE)) == "try-error"){
    print(paste("No file for:", i))
  next 
    print(paste("downnloading:", i))
  }
}


## Checking data from the other archive link:

# seq_dates <- format(seq(from = as.Date("2020/12/27"), to = today(), by = "1 days"), "%Y%m%d")
# 
# base_url <- "https://info.gesundheitsministerium.at/data/COVID19_vaccination_agegroups_v202210_"
# 
# days_df_other <- data.frame(base = rep(base_url, 
#                                   times = length(seq_dates)),
#                        date = seq_dates) %>% 
#   mutate(url = paste0(base, date, ".csv"),
#          date = ymd(date),
#          destinations = paste0(dir_source_download, "/BeforeNov2022/Austria_Age_vaccine", date, ".csv"))
# 
# 
# 
# for(i in seq_along(days_df_other$url)){
#   if(class(try(download.file(days_df_other$url[i],
#                              destfile = days_df_other$destinations[i],
#                              mode="wb"),
#                silent = TRUE)) == "try-error"){
#     print(paste("No file for:", i))
#   next 
#     print(paste("downnloading:", i))
#   }
# }


files_to_read = list.files(
  path = paste0(dir_source_download, "/"),        # directory to search within
  pattern = ".csv", # regex pattern, some explanation below
  recursive = TRUE,          # search subdirectories
  full.names = TRUE          # return the full path
)

files_to_read <- setNames(files_to_read, files_to_read)

files_in_dataframe <- map_dfr(files_to_read, read_csv2, .id = "file_name")
  # mutate(Date = str_extract(path, "\\d+-\\d+-\\d+")) %>% 
  # {map2_dfr(.$path, .$Date, function(x,y) read.csv2(x) %>% mutate(Date=y))}


vacc_out <- files_in_dataframe %>% 
  select(Date = 2, 
         state_id, 
         Region = state_name, 
         Age = age_group, Sex = gender, 
         Measure = vaccination,
         Value = vaccinations_administered_cumulative) %>% 
  filter(Region != "Österreich") %>% # somehow, they added a row for 'All', a duplicate of the state_id no. 10
  mutate(Date = ymd(str_sub(Date, 1, 10)),
         Age = case_when(Age == "00-11" ~ "0",
                         Age == "12-14" ~ "12",
                         Age == "15-24" ~ "15",
                         Age == "25-34" ~ "25",
                         Age == "35-44" ~ "35",
                         Age == "45-54" ~ "45",
                      Age == "55-64" ~ "55",
                      Age == "65-74" ~ "65",
                      Age == "75-84" ~ "75",
                      Age == "85+" ~ "85",
                      Age == "NotAssigned" ~ "UNK"),
         Sex = case_when(Sex == "Male" ~ "m",
                      Sex == "Female" ~ "f",
                      Sex == "NonBinary" ~ "NonBinary",
                      Sex == "Other" ~ "UNK",
                      Sex == "NotAssigned" ~ "UNK"),
         Measure = paste0("Vaccination", Measure),
         Region = case_when(
           Region == "NoState" ~ "UNK",
           Region == "Ã–sterreich" ~ "All",
           Region == "KÃ¤rnten" ~ "Kärnten",
           Region == "NiederÃ¶sterreich" ~ "Niederöstereich",
           Region == "OberÃ¶sterreich" ~ "Oberösterreich",
           TRUE ~ Region),
         Measure = case_when(Measure == "Vaccination4+" ~ "Vaccination4", TRUE ~ Measure),
         Code = paste0(ifelse(state_id < 10, paste0("AT-", state_id), "AT"))) %>% 
  group_by(Date, Age, Sex, Code, Region, Measure) %>% 
  summarize(Value = sum(Value)) %>% 
  ungroup() %>% 
  distinct(Date, Age, Sex, Region, Code,Measure, Value) %>% 
  mutate(Country = "Austria",
         Metric = "Count",
         Date = ddmmyyyy(Date),
         AgeInt = case_when(Age == "0" ~  12L,
                            Age == "12" ~ 3L,
                            Age == "85" ~ 20L,
                            #Age == "TOT" ~ "",
                            Age == "UNK" ~ NA_integer_,
                            TRUE ~ 10L),
         Code = case_when(Region == "UNK" ~ "AT-UNK+",
                          TRUE ~ Code)) %>% 
  select(Country, Region, Code, Date, Sex, Age, AgeInt, Metric, Measure, Value) %>% 
  sort_input_data()


```



# Hong Kong

##├ Date: 23.05.2023

Hongkong Vaccination data has duplicates in 05.01.2023, so by inspection turns out that the highest value is the correct one, based on reviewing the preceding and following date data values, 

here we do the appropriate handling:


```{r}

# info country and N drive address
ctr <- "Hong_Kong_Vaccine"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"

DataArchived <- readRDS("N:/COVerAGE-DB/Automation/Hydra/Hong_Kong_Vaccine.rds")

vax_data <- DataArchived |> 
  filter(str_detect(Measure, "Vacc"))

## The following is to add at the end:

epi_data <- DataArchived |> 
  filter(!str_detect(Measure, "Vacc"))

vax_data_add <- vax_data |> 
  filter(Date != "05.01.2023")

vacc_duplicated <- DataArchived |> 
  filter(Date == "05.01.2023") |> 
  group_by(Region, Sex, Age, AgeInt, Measure) |> 
  filter(Value == min(Value)) |> 
  unique()
  

out_all_again <- vacc_duplicated |> 
  bind_rows(vax_data_add) |> 
  bind_rows(epi_data) |> 
  sort_input_data()


write_rds(out_all_again, paste0(dir_n, ctr, ".rds"))

```





# South Korea

BRIEF: error in the coding, we missed the cases data for the period: 21.03.2022- 06.09.2022, inclusive. 
Solution: got the webarchive data, 6 files and added the cases data manually into Excel file, remove the missed up part from the dataset and merge the manually collected. 


```{r}

# info country and N drive address
ctr    <- "SouthKorea"
dir_n  <- "N:/COVerAGE-DB/Automation/Hydra/"
dir_n_source <- "N:/COVerAGE-DB/Automation/SouthKorea"

current_db <- read_rds(paste0(dir_n, ctr, ".rds")) %>% 
  mutate(Date = dmy(Date))


data_toremove <- current_db %>% 
  filter(Date >= "2022-03-21", Date <= "2022-09-06",
         Measure == "Cases", Age != "TOT")

data_cleaned <- current_db %>% 
  anti_join(data_toremove) %>% 
  mutate(Date = ddmmyyyy(Date))

#SK-MissingData

missingcases <- read_excel(paste0(dir_n, "/Data_sources/", ctr, "/SK-MissingData/SouthKorea.xlsx")) 
  
out <- data_cleaned %>% 
  bind_rows(missingcases) %>% 
  sort_input_data()

write_rds(out,  paste0(dir_n, ctr, ".rds"))

```


# South Korea

Then we got the shared updated link for Cases. 

```{r}

# info country and N drive address
ctr    <- "SouthKorea"
dir_n  <- "N:/COVerAGE-DB/Automation/Hydra/"
dir_n_source <- "N:/COVerAGE-DB/Automation/SouthKorea"

current_db <- read_rds(paste0(dir_n, ctr, ".rds")) %>% 
  mutate(Date = dmy(Date))

data_source <- paste0(dir_n, "Data_sources/", ctr, "/ExcelReferenceData/cases_",today(), ".xlsx")

cases_url <- "http://ncov.mohw.go.kr/board/doFileDownload.do?file_name=%EC%BD%94%EB%A1%9C%EB%82%98%EB%B0%94%EC%9D%B4%EB%9F%AC%EC%8A%A4%EA%B0%90%EC%97%BC%EC%A6%9D-19_%ED%99%95%EC%A7%84%ED%99%98%EC%9E%90_%EB%B0%9C%EC%83%9D%ED%98%84%ED%99%A9_220922.xlsx&file_path=/upload/ncov/file/202209/1663821660861_20220922134100.xlsx"


download.file(cases_url, destfile = data_source, mode = "wb")


raw_data <- read_excel(data_source, sheet = 2) %>% 
  slice(-1)

col_names <- c("Date", "Cases_TOT", "Cases_0",
               "Cases_10", "Cases_20", "Cases_30",
               "Cases_40", "Cases_50", "Cases_60",
               "Cases_70", "Cases_80")

names(raw_data) <- col_names

rawdata_2 <- raw_data %>% 
  mutate(Date = as.numeric(Date),
         Date = as.Date(Date, origin = "1899-12-30"),
         across(.cols = -c("Date"), as.integer),
         across(.cols = -c("Date"), ~replace_na(., 0)))


processed_data <-  rawdata_2 %>% 
  arrange(Date) %>% 
  pivot_longer(cols = -c(Date),
               names_to = c("Measure", "A_Age"),
               names_sep = "_",
               values_to = "Excel_value") %>% 
  tidyr::complete(A_Age, Measure,
                  Date = seq(min(rawdata_2$Date), max(rawdata_2$Date), by = "day"),
                  fill = list(Excel_value = 0)) %>% 
  pivot_wider(names_from = "A_Age", values_from = "Excel_value") %>% 
  mutate(across(.cols = -c("Date", "Measure"), ~ cumsum(.x))) %>% 
  pivot_longer(cols = -c("Date", "Measure"),
               names_to = c("A_Age"),
               values_to = "Excel_value") %>% 
  rename(date_d = Date)


check_retro <- current_db %>% 
  filter(Measure == "Cases") %>% 
  select(Date, Age, Value) %>% 
  inner_join(processed_data, by = c("Date" = "date_d",
                                    "Age" = "A_Age"))


data_toremove <- current_db %>% 
  filter(Date >= "2022-03-21", Date <= "2022-09-06",
         Measure == "Cases", Age != "TOT")




```

























# Isle of Man

```{r}
ctr          <- "Isle_of_Man" # it's a placeholder
dir_n        <- "N:/COVerAGE-DB/Automation/Hydra/"

```



# Spain

##├ Date: 25.08.2022
Problem: Missing vaccination data .ods files between 03.01.2022 and 31.01.2022 (inclusive)


```{r}
# info country and N drive address
ctr <- "Spain_vaccine"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"
files_source <- paste0(dir_n, "Data_sources/", ctr, "/Missing_03012022-31012022/")

earlier_source <- "C:/Users/elzalabany/Downloads/Data/"

## 1. DOWNLOAD THE MISSING .ods FILES 
# creating a sequence of missing data files 

## example <- https://www.sanidad.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov/documentos/Informe_Comunicacion_20220103.ods

seq_dates <- format(seq(from = as.Date("2020/02/02"), to = as.Date("2021/05/20"), by = "1 days"), "%Y%m%d")

#seq_dates <- format(seq(from = as.Date("2021/01/03"), to = as.Date("2022/01/31"), by = "1 days"), "%Y%m%d")

base_url <- "https://www.sanidad.gob.es/profesionales/saludPublica/ccayes/alertasActual/nCov/documentos/Informe_Comunicacion_"

days_df <- data.frame(base = rep(base_url, 
                                  times = length(seq_dates)),
                       date = seq_dates) %>% 
  mutate(url = paste0(base, date, ".ods"),
         date = ymd(date),
         destinations = paste0(earlier_source, "Spain_vaccine", date, ".ods"))


for(i in seq_along(days_df$url)){
  if(class(try(download.file(days_df$url[i],
                             destfile = days_df$destinations[i],
                             mode="wb"),
               silent = TRUE)) == "try-error"){
    print(paste("No file for:", i))
  next 
    print(paste("downnloading:", i))
  }
}


## GET IN THE DATA ## ===================

source(here::here("Automation/00_Functions_automation.R"))
library(readODS)
# assigning Drive credentials in the case the script is verified manually  
if (!"email" %in% ls()){
  email <- "mumanal.k@gmail.com"
}

# info country and N drive address
ctr          <- "Spain_vaccine" # it's a placeholder
dir_n        <- "N:/COVerAGE-DB/Automation/Hydra/"

files_source <- paste0(dir_n, "Data_sources/", ctr, "/Data-till-2022August25/")

trial_path <- paste0("U:/", ctr, "/")

files <- list.files(path = files_source,
                    pattern = ".ods",
                    full.names = TRUE) 

files_df <- data.frame(file_path = files)

#####################

total_2021 <- "Hoja3" ## total sheet from 04.01.2021 till 02.03.2021

total_sheet <- "Comunicación"

## dose 1 and dose 2 sheets from 31.03.2021

dose_1 <- "Etarios_con_al_menos_1_dosis"
dose_2 <- "Etarios_con_pauta_completa"
dose_3 <- "Dosis_refuerzo"
young <- c("Pediatrica", "5-11_años", "Pediátrica")



## FUNCTIONS ## 

## read in sheets 
df_paths_sheets <- function(tbl, number_sheet){

  tbl %>% 
    mutate(sheet_number = number_sheet) %>% 
    {map2_df(.$file_path, .$sheet_number, ~read.ods(file = .x, sheet = .y) %>% 
               mutate(id = .x))} %>% 
    left_join(tbl, by = c("id" = "file_path"))
}

## final edits to totals tables

total_final_edit <- function(tbl){
  tbl %>% 
  pivot_longer(-c("Region", "Date"), names_to= "Measure", values_to= "Value") %>% 
  dplyr::filter(!Region %in% c("Fuerzas Armadas","Sanidad Exterior" )) %>% # delete armed forces from region
  mutate(Short = recode(Region,
                        "Andalucía" = "AN",
                        "Aragón" = "AR",
                        "Asturias"= "AS", 
                        "Baleares" ="IB",
                        "Canarias" ="CN",
                        "Cantabria"= "CB",
                        "Castilla y Leon"= "CL",
                        "Castilla La Mancha"= "CM",
                        "Cataluña" ="CT",
                        "C. Valenciana" ="VC",
                        "Extremadura"= "EX",
                        "Galicia"= "GA",
                        "La Rioja" ="RI",
                        "Madrid"= "M",
                        "Murcia"= "MU",
                        "Navarra"= "NA",
                        "País Vasco" ="PV",
                        "Ceuta"= "CE",
                        "Melilla" ="ML",
                        "Totales"= "All"), 
         Code = case_when(Short == "All" ~ "ES",
                          TRUE ~ paste0("ES-", Short)),
         Region = case_when(
           Region == "Totales" ~ "All",
           TRUE ~ Region
         ),
         Metric= "Count",
         Sex = "b",
         Age = "TOT", 
         AgeInt = NA_integer_, 
         Date = ddmmyyyy(Date),
         Country = "Spain") %>% 
    select(-Short)
}


## The structure of the sheet is frequently changing over time, so the following code is to read the files where the cut-off date based on changing structure of the data 

## TOTALS: SHEET 1 ##

out_totals1_1 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-02-01", date < "2021-02-09") %>% 
  df_paths_sheets(total_2021)


processed_totals1_1 <- out_totals1_1 %>% 
  select(id, 
         Date = H,
         Region = A, 
         Vaccination2= G) %>% 
  mutate(Vaccination2 = str_extract(Vaccination2, "\\d+"),
         Date = dmy(Date)) %>% 
  filter(!is.na(Vaccination2)) %>% 
  fill(Date, .direction = "down") %>% 
  group_by(id) %>% 
  mutate(Date = max(Date)) %>% 
  ungroup()  

## =====

out_totals1_2 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date >= "2021-02-09", date <= "2021-03-02") %>%
  df_paths_sheets(total_2021)


processed_totals1_2 <- out_totals1_2 %>% 
  select(id, 
         Date = I,
         Region = A, 
         Vaccination2= H) %>% 
  mutate(Vaccination2 = str_extract(Vaccination2, "\\d+"),
         Date = dmy(Date)) %>% 
  filter(!is.na(Vaccination2)) %>% 
  fill(Date, .direction = "down") %>% 
  group_by(id) %>% 
  mutate(Date = max(Date)) %>% 
  ungroup() 

## =====

out_totals2_1 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-03-02", date <= "2021-04-05") %>%
  df_paths_sheets(total_sheet)

processed_totals2_1 <- out_totals2_1 %>% 
  select(id, 
         Date = I,
         Region = A, 
         Vaccination2= H) %>% 
  mutate(Vaccination2 = str_extract(Vaccination2, "\\d+"),
         Date = dmy(Date)) %>% 
  filter(!is.na(Vaccination2)) %>% 
  fill(Date, .direction = "down") %>% 
  group_by(id) %>% 
  mutate(Date = max(Date)) %>% 
  ungroup()

## =====

out_totals2_2 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-04-05", date < "2021-04-22") %>%
  df_paths_sheets(total_sheet)


processed_totals2_2 <- out_totals2_2 %>% 
  select(id, 
         Date = J,
         Region = A, 
         Vaccination1 = H,
         Vaccination2 = I) %>% 
  mutate(Vaccination2 = str_extract(Vaccination2, "\\d+"),
         Date = dmy(Date)) %>% 
  filter(!is.na(Vaccination2)) %>% 
  fill(Date, .direction = "down") %>% 
  group_by(id) %>% 
  mutate(Date = max(Date)) %>% 
  ungroup() 


## =====

out_totals2_3 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-04-21", date < "2021-10-07") %>%
  df_paths_sheets(total_sheet) 


processed_totals2_3 <- out_totals2_3 %>% 
  select(id, 
         Date = K,
         Region = A, 
         Vaccination1 = I,
         Vaccination2 = J) %>% 
  mutate(Vaccination2 = str_extract(Vaccination2, "\\d+"),
         Date = dmy(Date)) %>% 
  filter(!is.na(Vaccination2)) %>% 
  fill(Date, .direction = "down") %>% 
  group_by(id) %>% 
  mutate(Date = max(Date)) %>% 
  ungroup() 

## =====

out_totals2_4 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date >= "2021-10-07", date < "2021-12-21") %>%
  df_paths_sheets(total_sheet)


processed_totals2_4 <- out_totals2_4 %>% 
  select(id, 
         Date = L,
         Region = A, 
         Vaccination1 = I,
         Vaccination2 = J,
         Vaccination3 = K) %>% 
  mutate(Vaccination2 = str_extract(Vaccination2, "\\d+"),
         Date = dmy(Date)) %>% 
  filter(!is.na(Vaccination2)) %>% 
  fill(Date, .direction = "down") %>% 
  group_by(id) %>% 
  mutate(Date = max(Date)) %>% 
  ungroup() 


## =====

out_totals2_5 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date >= "2021-12-21") %>%
  df_paths_sheets(total_sheet)


processed_totals2_5 <- out_totals2_5 %>% 
  select(id, 
         Date = M,
         Region = A, 
         Vaccination1 = J,
         Vaccination2 = K,
         Vaccination3 = L) %>% 
  mutate(Vaccination2 = str_extract(Vaccination2, "\\d+"),
         Date = dmy(Date)) %>% 
  filter(!is.na(Vaccination2)) %>% 
  fill(Date, .direction = "down") %>% 
  group_by(id) %>% 
  mutate(Date = max(Date)) %>% 
  ungroup()


out_total <- bind_rows(processed_totals1_1,
                       processed_totals1_2,
                       processed_totals2_1,
                       processed_totals2_2,
                       processed_totals2_3,
                       processed_totals2_4,
                       processed_totals2_5)


total_final <- out_total %>% 
  distinct(Date, Region, Vaccination1, Vaccination2, Vaccination3, .keep_all = TRUE) 


dates_tomerge <- total_final %>% 
  distinct(Date, id) 


out_total_date <- total_final %>% 
  select(-id) %>% 
  total_final_edit() %>% 
  filter(!is.na(Value))

## PROCESSING THE DATA as per the usual code =========================

vax_process <- function(tbl){
  
  tbl %>% 
  dplyr::filter(!Region %in% c("Fuerzas Armadas",
                               "Fuerzas Armadas*",
                               "Sanidad Exterior" )) %>% # delete armed forces from region  
  mutate(Region = recode(Region,
                         "Totales" = "All",
                         "Total España"= "All",
                         "Castilla - La Mancha"= "Castilla La Mancha"),
         Short = recode(Region,
                        "Andalucía" = "AN",
                        "Aragón" = "AR",
                        "Asturias"= "AS", 
                        "Baleares" ="IB",
                        "Canarias" ="CN",
                        "Cantabria"= "CB",
                        "Castilla y Leon"= "CL",
                        "Castilla y León" = "CL",
                        "Castilla La Mancha"= "CM",
                        "Cataluña" ="CT",
                        "C. Valenciana" ="VC",
                        "Extremadura"= "EX",
                        "Galicia"= "GA",
                        "Galicia*" = "GA",
                        "La Rioja" ="RI",
                        "Madrid"= "M",
                        "Murcia"= "MU",
                        "Navarra"= "NA",
                        "País Vasco" ="PV",
                        "Ceuta"= "CE",
                        "Melilla" ="ML",
                        "All"= "All"),
         Region = case_when(Region == "Galicia*" ~ "Galicia",
                            TRUE ~ Region),
         Code = case_when(Short == "All" ~ "ES",
                          TRUE ~ paste0("ES-", Short)),
         Metric = "Count",
         Sex = "b",
         Country = "Spain") %>% 
    select(-Short)
}



check_consistency <- function(tbl){
  tbl %>% 
    mutate(across(.cols = -c("date"), ~ str_extract(.x, "\\w+\\w+ años"))) %>%
   filter(!is.na(B)) %>%
   View()
}

###################

## VAX1 ##

out_VAX1_1 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-03-30", date < "2021-06-08") %>%
  df_paths_sheets(dose_1)

# out_VAX1_1 %>% check_consistency()

processed_vax1_1 <- out_VAX1_1 %>% 
  select(Region = A,
         id,
         `80`= B,
         `70-79`= E, 
         `60-69`= `H`,
         `50-59`= K,
         `25-49`= N,
         `18-24` = Q,
         `16-17` = `T`) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination1") %>% 
  filter(`80` != "1") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "16" ~ 2L,
                            Age == "18" ~ 7L,
                            Age == "25" ~ 25L,
                            Age == "50" ~ 10L,
                            Age == "60" ~ 10L,
                            Age == "70" ~ 10L,
                            Age == "80" ~ 25L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 

## ======

out_VAX1_2 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date >= "2021-06-08", date <= "2021-06-20") %>%
  df_paths_sheets(dose_1)


# out_VAX1_2 %>% check_consistency()


processed_vax1_2 <- out_VAX1_2 %>% 
  select(Region = A,
         id,
         `80`= B,
         `70-79`= D, 
         `60-69`= `F`,
         `50-59`= H,
         `40-49` = J,
         `25-39`= L,
         `18-24` = N,
         `16-17` = `P`) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination1") %>% 
  filter(`80` != "1") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "16" ~ 2L,
                            Age == "18" ~ 7L,
                            Age == "25" ~ 15L,
                            Age == "40" ~ 10L,
                            Age == "50" ~ 10L,
                            Age == "60" ~ 10L,
                            Age == "70" ~ 10L,
                            Age == "80" ~ 25L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 



## ======

out_VAX1_3 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-06-20") %>%
  df_paths_sheets(dose_1)


# out_VAX1_3 %>% check_consistency()


processed_vax1_3 <- out_VAX1_3 %>% 
  select(Region = A,
         id,
         `80`= B,
         `70-79`= D, 
         `60-69`= `F`,
         `50-59`= H,
         `40-49` = J,
         `30-39` = L,
         `20-29`= N,
         `12-19` = `P`) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination1") %>% 
  filter(`80` != "1") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "12" ~ 8L,
                            Age == "20" ~ 10L,
                            Age == "30" ~ 10L,
                            Age == "40" ~ 10L,
                            Age == "50" ~ 10L,
                            Age == "60" ~ 10L,
                            Age == "70" ~ 10L,
                            Age == "80" ~ 25L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 




## VAX2 ##

## ===========

out_VAX2_1 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-03-30", date <= "2021-06-03") %>%
  df_paths_sheets(dose_2)



# out_VAX2_1 %>% check_consistency()

processed_vax2_1 <- out_VAX2_1 %>% 
  select(Region = A,
         id,
         `80`= B ,
         `70-79`= E, 
         `60-69`= H,
         `50-59`= K, 
         `25-49`= N, 
         `18-24`= Q,
         `16-17`= `T`) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination2") %>% 
  filter(`80` != "80") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "16" ~ 2L,
                            Age == "18" ~ 7L,
                            Age == "25" ~ 25L,
                            Age == "50" ~ 10L,
                            Age == "60" ~ 10L,
                            Age == "70" ~ 10L,
                            Age == "80" ~ 25L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 


## ===========

out_VAX2_2 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-06-03", date <= "2021-06-20") %>%
  df_paths_sheets(dose_2)



#out_VAX2_2 %>% check_consistency()

processed_vax2_2 <- out_VAX2_2 %>% 
  select(Region = A,
         id,
         `80`= B ,
         `70-79`= D, 
         `60-69`= `F`,
         `50-59`= H, 
         `40-49`= J, 
         `25-49`= L,
         `18-24`= N,
         `16-17`= P) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination2") %>% 
  filter(`80` != "80") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "16" ~ 2L,
                            Age == "18" ~ 7L,
                            Age == "25" ~ 15L,
                            Age == "40" ~ 10L,
                            Age == "50" ~ 10L,
                            Age == "60" ~ 10L,
                            Age == "70" ~ 10L,
                            Age == "80" ~ 25L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 



## =========== 

out_VAX2_3 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-06-20") %>%
  df_paths_sheets(dose_2)



#out_VAX2_3 %>% check_consistency()

processed_vax2_3 <- out_VAX2_3 %>% 
  select(Region = A,
         id,
         `80`= B ,
         `70-79`= D, 
         `60-69`= `F`,
         `50-59`= H, 
         `40-49`= J, 
         `30-39`= L,
         `20-29`= N,
         `12-19`= P) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination2") %>% 
  filter(`80` != "80") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "12" ~ 8L,
                            Age == "20" ~ 10L,
                            Age == "30" ~ 10L,
                            Age == "40" ~ 10L,
                            Age == "50" ~ 10L,
                            Age == "60" ~ 10L,
                            Age == "70" ~ 10L,
                            Age == "80" ~ 25L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 


## ===============================


## VAX3 ##

## Data for third dose (booster dose) are added since 15.12.2021

out_VAX3_1 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-12-14", date <= "2021-12-22") %>% 
  df_paths_sheets(dose_3)



#out_VAX3_1 %>% check_consistency()


processed_vax3_1 <- out_VAX3_1 %>% 
  select(Region = A,
         id, 
         `70`= B ,
         `60-69`= D) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination3") %>% 
  filter(`70` != "70") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "60" ~ 10L,
                            Age == "70" ~ 35L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 


## ===============


out_VAX3_2 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-12-22", date < "2022-01-21") %>% 
  df_paths_sheets(dose_3)



#out_VAX3_2 %>% check_consistency()


processed_vax3_2 <- out_VAX3_2 %>% 
  select(Region = A,
         id, 
         `70`= B ,
         `60-69`= D,
         `50-59`= `F`, 
         `40-49`= H) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination3") %>% 
  filter(`70` != "70") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "40" ~ 10L,
                            Age == "50" ~ 10L,
                            Age == "60" ~ 10L,
                            Age == "70" ~ 35L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 



## ===============


out_VAX3_3 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date >= "2022-01-21", date < "2022-03-12") %>% 
  df_paths_sheets(dose_3)



#out_VAX3_3 %>% check_consistency()


processed_vax3_3 <- out_VAX3_3 %>% 
  select(Region = A,
         id, 
         `70`= B ,
         `60-69`= D, 
         `50-59`= `F`, 
          `40-49`= H, 
          `30-39`= J,
          `20-29`= L) %>% 
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination3") %>% 
  filter(`70` != "70") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "70" ~ 35L,
                            TRUE ~ 10L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 


## ===============

out_VAX3_4 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date >= "2022-03-12") %>% 
  df_paths_sheets(dose_3)



#out_VAX3_4 %>% check_consistency()


processed_vax3_4 <- out_VAX3_4 %>% 
  select(Region = A,
         id, 
         `70`= B ,
         `60-69`= D, 
         `50-59`= `F`,
         `40-49`= H,
         `30-39`= J,
         `20-29`= L,
         `18-19`= N) %>%
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination3") %>% 
  filter(`70` != "70") %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = case_when(Age == "70" ~ 35L,
                            Age == "18" ~ 2L,
                            TRUE ~ 10L),
         Date = ddmmyyyy(Date)) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 



#############################################################

## VAX Pediatrics (less than 11 yrs old): SHEET 6 ##

## Data for young age are added after 20.12.2021

#### 1st dose ===============

out_VAXPed1 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2021-12-20", date <= "2022-03-11") %>% 
  df_paths_sheets("5-11_años") %>% 
  select(Region  = A,
         `5-11` = C,
         id) %>%
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+")),
         Measure = "Vaccination1") %>% 
  filter(str_detect(Region, "\\w+")) %>% 
  pivot_longer(-c("Region", "id", "Measure"), names_to= "Age", values_to= "Value") %>%
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  separate(Age, into = c("Age", "Nothing"), sep = "-") %>% 
  mutate(AgeInt = 7L) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value) 


#### 1st & 2nd dose ===============

out_VAXPed2 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date > "2022-03-11", date < "2022-07-30") %>% 
  df_paths_sheets("Pediatrica") %>% 
  select(Region  = A,
         `Vaccination1_5` = C,
         `Vaccination2_5` = E,
         id) %>%
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+"))) %>% 
  filter(str_detect(Region, "\\w+")) %>% 
  pivot_longer(-c("Region", "id"), names_to= "Age", values_to= "Value") %>%
  separate(Age, into = c("Measure", "Age"), sep = "_") %>% 
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  mutate(AgeInt = 7L) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value)



#### 1st & 2nd dose (different sheet name) ===============

out_VAXPed3 <- files_df %>% 
  mutate(date = ymd(str_extract(file_path, "\\d+-\\d+-\\d+"))) %>% 
  filter(date >= "2022-07-30") %>% 
  df_paths_sheets("Pediátrica") %>% 
  select(Region  = A,
         `Vaccination1_5` = C,
         `Vaccination2_5` = E,
         id) %>%
  mutate(across(.cols = -c("Region", "id"), ~str_extract(.x, "\\d+"))) %>% 
  filter(str_detect(Region, "\\w+")) %>% 
  pivot_longer(-c("Region", "id"), names_to= "Age", values_to= "Value") %>%
  separate(Age, into = c("Measure", "Age"), sep = "_") %>% 
  vax_process() %>% 
  inner_join(dates_tomerge, by = "id") %>% 
  mutate(AgeInt = 7L) %>% 
  select(Country, Region, Code, Date, Sex, 
         Age, AgeInt, Metric, Measure, Value)



out_VAXPed <- bind_rows(out_VAXPed1, out_VAXPed2, out_VAXPed3) %>% 
  mutate(Date = ddmmyyyy(Date))

## endlish, merging all files ! 

out <- bind_rows(out_total_date,
                 processed_vax1_1,
                 processed_vax1_2,
                 processed_vax1_3,
                 processed_vax2_1,
                 processed_vax2_2,
                 processed_vax2_3,
                 processed_vax3_1,
                 processed_vax3_2,
                 processed_vax3_3,
                 processed_vax3_4,
                 out_VAXPed) %>%
  sort_input_data()



## reviewing the data quality 
## should be 20 rows per Region (20 regions), Age (9-10 Age groups), Measure

out %>% group_by(Date, Age, Measure) %>% 
  count() %>% 
 # distinct() %>% 
  filter(n > 20) %>% 
  View()

write_rds(out, paste0(files_source, ctr, "Data17Aug2022.rds"))

edited_data <- read_rds(paste0(files_source, ctr, "Data17Aug2022.rds"))


dataafter17Aug <- read_rds(paste0(dir_n, ctr, ".rds")) %>% 
  mutate(AgeInt = as.integer(AgeInt),
         Value = as.numeric(Value),
         Date = dmy(Date)) %>% 
  filter(Date > "2022-08-17")


dedplicates_errorsremoved <- dataafter17Aug %>% 
  group_by(Date, Region, Age, Measure) %>% 
  mutate(Value = max(Value)) %>% 
  distinct() %>% 
  mutate(Date = ddmmyyyy(Date),
         Value = as.character(Value))


final_out <- bind_rows(edited_data, dedplicates_errorsremoved) %>% 
  mutate(Region = case_when(Region == "Totales" ~ "All",
                            TRUE ~ Region),
         Code = case_when(Code == "ES-All" ~ "ES",
                          TRUE ~ Code))

write_rds(final_out, paste0(dir_n, ctr, ".rds"))

```






# Denmark

##├ Date: 12.08.2022
Problem: Missing vaccination dose 4 data between 22.06.2022 and 03.08.2022 (inclusive)


```{r}


# info country and N drive address
ctr <- "Denmark"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"
dir_n_missing <- "N:/COVerAGE-DB/Automation/Hydra/Data_sources/"
dir_n_source <- "N:/COVerAGE-DB/Automation/Denmark/"





files_to_read = list.files(
  path = paste0(dir_n_missing, ctr, "/MissingFourthDose"),        # directory to search within
  pattern = "Vaccine_region_alder_koen_vaccage.csv", # regex pattern, some explanation below
  recursive = TRUE,          # search subdirectories
  full.names = TRUE          # return the full path
)

files_in_dataframe <- data.frame(path = files_to_read) %>% 
  mutate(Date = str_extract(path, "\\d+-\\d+-\\d+")) %>% 
  {map2_dfr(.$path, .$Date, function(x,y) read.csv2(x) %>% mutate(Date=y))}


db_v2 <- files_in_dataframe %>% 
      select(Date, 
             Age = 2,
             Sex = 3,
             Value = 7) %>% 
  ## THESE DATA ARE BY REGION, SO WE SUM THE VALUES ## 
      group_by(Date, Age, Sex) %>% 
      summarise(Value = sum(Value),.groups = "drop") %>% 
      mutate(Measure = "Vaccination4",
             Sex = recode(Sex,
                          "K" = "f",
                          "M" = "m"),
             Age = str_sub(Age, 1, 2),
             Age = case_when(Age == "0-" ~ "0",
                             is.na(Age) ~ "UNK",
                             TRUE ~ Age))
    
    db_v3 <- 
      db_v2 %>% 
      bind_rows(
        db_v2 %>% 
          group_by(Sex, Measure, Date) %>% 
          summarise(Value = sum(Value), .groups = "drop") %>% 
          mutate(Age = "TOT")
      ) %>% 
      dplyr::filter(Age != "UNK") %>% 
      mutate(Date = ddmmyyyy(Date),
           Country = "Denmark",
           Code = "DK",
           Region = "All",
           AgeInt = case_when(Age == "90" ~ 15L, 
                              Age == "TOT" ~ NA_integer_,
                              Age == "UNK" ~ NA_integer_,
                              TRUE ~ 10L),
           Metric = "Count") 
    

  ## MERGE WITH THE .RDS FILE 
    
Denmark <- readRDS("N:/COVerAGE-DB/Automation/Hydra/Denmark.rds")

out <- Denmark %>% 
  bind_rows(db_v3) %>% 
  sort_input_data()

write_rds(out, paste0(dir_n, ctr, ".rds"))

```


##├ Date: 29.08.2022
Problem: Failures: Measure: Deaths, bad age and duplicates between 17.02.2022 and 22.05.2022 (inclusive). 
Solution: turns out that these dates are missing data (ie. we don't have the original files and these data are not in google input template- except 17.05.2022), plus the Value is not consistent with the preceeding or the following dates, so I decided to keep this error for now or we can remove these dates from the dataset. 

Dates with issues: 
1: 2022-02-17
2: 2022-03-16
3: 2022-03-17
4: 2022-05-17
5: 2022-05-18
6: 2022-05-19
7: 2022-05-20
8: 2022-05-21
9: 2022-05-22

```{r}


# info country and N drive address
ctr <- "Denmark"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"
dir_n_missing <- "N:/COVerAGE-DB/Automation/Hydra/Data_sources/"
dir_n_source <- "N:/COVerAGE-DB/Automation/Denmark/"


db_n <- read_rds(paste0(dir_n, ctr, ".rds")) %>% 
  mutate(Date = dmy(Date))


```


##├ Date: 15.12.2022

```{r}

## missing Cases files from 06-12-2022 to 13-12.2022 

epi.list <-list.files(
  path = "N:/COVerAGE-DB/Automation/Hydra/Data_sources/Denmark/MissingCases6-12-2022",
  pattern = ".csv",
  full.names = TRUE)


epi.list <- setNames(epi.list, epi.list) # only needed when you need an id-column with the file-names


sourcedata_epi <- map_dfr(epi.list, read_csv2, .id = "file_name") %>% 
  mutate(file_name = str_remove(file_name, "N:/COVerAGE-DB/Automation/Hydra/Data_sources/Denmark/MissingCases6-12-2022/Cases_by_sex_"),
         Date = str_remove(file_name, ".csv"),
         Date = dmy(Date))

processed <- sourcedata_epi %>% 
  select(-file_name) %>% 
  rename(Age = 1,
         f = 2,
         m = 3,
         b = 4) %>% 
  mutate(f = str_remove_all(f, "\\."),
         m = str_remove_all(m, "\\."),
         b = as.character(b)) %>%
  tidyr::pivot_longer(cols = -c("Age", "Date"), names_to = "Sex", values_to = "Values") %>% 
  tidyr::separate(Values, c("Value", "trash"), sep = " ") %>% 
  mutate(Value = as.numeric(Value)) %>% 
  select(-trash) %>% 
  separate(Age, c("Age", "trash"), sep = "-") %>% 
  mutate(Age = case_when(Age == "90+" ~ "90",
                         Age == "I alt" ~ "TOT",
                         TRUE ~ Age),
         Age = as.character(Age)) %>% 
  select(-trash) 



```


##├ Date: 15.12.2022

Denmark Vaccination Data: Since 12.10.2022, Denmark authorities changed the definition and the measures reported for vaccination.
As published in the "0_readme_fil_vaccinationsDB", instead of reporting by dose number (as since early 2021), they reported the status of the individual. 
so, Primary vaccination as the counts of those received two doses
and booster are for those received three doses or more. 
Implications: 
* the data we have since 12 Oct. are not consistent with the preceding data, so the analyses showed drops. 
* we may need to discuss how/ whether to keep adding these data and how we may keep the definitions consistent?!
* until this discussion, and to avoid losing data (the authorities mentioned that the zip files will be available for sometime), I here downloaded all the .zip files since its is published.

Also, the code is adjusted to just download the data for the moment. 


```{r}

urls <- rvest::read_html("https://covid19.ssi.dk/overvagningsdata/download-fil-med-vaccinationsdata") %>% 
   rvest::html_nodes("a ") %>% 
   rvest::html_attr('href') 


urls_df <- data.frame(zip_url = urls) %>% 
  filter(str_detect(zip_url, "zipfil")) %>% 
  mutate(date_prep = str_remove_all(zip_url, "https://files.ssi.dk/covid19/vaccinationsdata/zipfil/covid19-vaccinationsdata-"),
         date_prep = str_remove(date_prep, "https://files.ssi.dk/covid19/vaccinationsdata/zipfil/vaccinationsdata-dashboard-covid19-"),
         date_prep = str_remove(date_prep, "https://files.ssi.dk/covid19/vaccinationsdata/zipfil/covid-19-vaccinationsdata-"),
         date_prep = str_extract(date_prep, "\\d+"),
         date_prep = dmy(date_prep),
         destinations = paste0("N:/COVerAGE-DB/Automation/Hydra/Data_sources/Denmark/DenmarkVax-AllData/", date_prep, ".zip")) %>% 
  distinct()


urls_df %>% 
  {map2(.$zip_url, .$destinations, ~ download.file(url = .x, destfile = .y, mode="wb"))}

```



##├ Date: 23.05.2023

Denmark cases data has duplicates in 20.10.2022 & 27.10.2022, so by inspection turns out that the highest value is for the following date, 21.10.2022 & 28.10.2022, , based on reviewing the preceding and following date data values, 

here we do the appropriate handling:


```{r}

# info country and N drive address
ctr <- "Denmark"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"

DataArchived <- readRDS("N:/COVerAGE-DB/Automation/Hydra/Denmark.rds")

cases_data <- DataArchived |> 
  filter(Measure == "Cases")

## The following is to add at the end:

deaths_data <- DataArchived |> 
  filter(Measure != "Cases")

cases_data_add <- cases_data |> 
  filter(!Date %in% c("20.10.2022", "27.10.2022"))

cases_min_add <- cases_data |> 
  filter(Date %in% c("20.10.2022", "27.10.2022")) |> 
  group_by(Date, Region, Sex, Age, AgeInt, Measure) |> 
  filter(Value == min(Value)) |> 
  unique()

## Seems that there is an error in the date of these data, 
## should be Friday 21.10.2022 and Friday 28.10.2022 instead of
## the duplicates: 20.10.2022 and 27.10.2022 

cases_max_datechange_add <- cases_data |> 
  filter(Date %in% c("20.10.2022", "27.10.2022")) |> 
  group_by(Date, Region, Sex, Age, AgeInt, Measure) |> 
  filter(Value == max(Value)) |> 
  unique() |> 
  mutate(Date = case_when(Date == "20.10.2022" ~ "21.10.2022",
                          Date == "27.10.2022" ~ "28.10.2022"))
  

out_all_again <- deaths_data |> 
  bind_rows(cases_data_add) |> 
  bind_rows(cases_min_add) |> 
  bind_rows(cases_max_datechange_add) |> 
  sort_input_data()


write_rds(out_all_again, paste0(dir_n, ctr, ".rds"))

```






# Sweden

##├ Date: 04.07.2022
Problem: Sweden download data each day, but the data are not appended to inputDB since 13.01.2022
Investigating the data a bit, I found there are multiple gaps though file names say that data are downloaded each day
to check on this whole country data: 

== Assumption is that if there is no epi-data for a specific date, there is no vaccination data as well (starting 2021), however, better to separate this step, just in case. 


##├ Date: from 29.06.2022 till 20.07.2022, data were not added - my bad: I forgot to append in the code. 

Mitigation: data are downloaded each day, I added 'manually' to the .rds file. 


```{r eval=FALSE, include=FALSE}

# info country and N drive address
ctr <- "Sweden"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/"


## read in the latest .rds file 

Sweden_drive <- readRDS("N:/COVerAGE-DB/Automation/Hydra/Sweden.rds")

## some check ups on this dataset

Sweden %>% 
  mutate(Date = lubridate::dmy(Date)) %>% 
  ggplot(aes(x = Date, y = Value)) + 
  geom_point() + 
  facet_wrap(facets = "Measure")


Sweden <- Sweden_drive %>% 
  mutate(Date = as.Date(Date, format = "%d.%m.%Y"),
         AgeInt = as.integer(AgeInt)) %>% 
  filter(Date != "2020-02-11") 

Sweden %>% 
  arrange(desc(Date)) ## last data date in .rds file is 13-01-2022 :O


## 1. Epi-data ==================

## load the xlsx files after unzipping and do some checks... 

epi.list <-list.files(
  #path= paste0(dir_n, "Epi-data/"),
                      path= paste0(dir_n, "29-06-25-07/Epi-data/"),
                       pattern = ".xlsx",
                       full.names = TRUE)


epi.list <- setNames(epi.list, epi.list) # only needed when you need an id-column with the file-names


## 1. this is to get the maximum date for each file "from the first sheet- default read_excel"

sourcedata_epi <- map_dfr(epi.list, read_excel, .id = "file_name")

## 2. check if the file name date is longer than one day difference with maximum date, if so, consider it duplicate

## condition in 2. is not necessarily valid, we have May 2021 data but the difference is so high that it is considered duplicates!

source_lastdate <- sourcedata_epi %>% 
  select(file_name, date = 2) %>% 
  mutate(date = lubridate::ymd(date)) %>% 
  group_by(file_name) %>% 
  summarise(max_date = max(date)) # %>% 
  # mutate(file_name = str_replace_all(file_name, "N:/COVerAGE-DB/Automation/Hydra/Data_sources/Sweden/2021/",
  #                             ""),
  #        file_date = lubridate::ymd(stringr::str_extract_all(file_name, '\\d+')),
  #        how_long = file_date - max_date,
  #        duplicate = if_else(how_long == 1, "No", "Yes")) 

# df_lastdate %>% 
#   filter(duplicate == "No") %>% 
#   View()



## so the better is to check the opposite way:

## 3. check whether the max_date is included in the .rds file or not. 


unique_dates <- Sweden %>% 
  filter(Measure %in% c("Cases", "Deaths")) %>% 
  distinct(Date)



to_retrieve_epi <- source_lastdate %>% 
  anti_join(unique_dates, by = c("max_date" = "Date")) %>% 
  distinct(max_date, .keep_all = TRUE) 


epi_files <- to_retrieve_epi %>% 
  dplyr::pull(file_name)


## function to go over the missing data files ==========

## and append first separately from the main dataset ##

# create empty df to add rows to
lost_epidates <- data.frame()

epi_gaps <- function(file_path){
  
  date <- read_excel(file_path,
                     sheet = 1) %>% 
    dplyr::pull(Statistikdatum) %>% 
    max() %>% 
    ymd()
  
  db_sex <- read_excel(file_path,
           sheet = 5) %>% 
  dplyr::rename(
    Sex = starts_with("K"),
    Cases = Totalt_antal_fall,
    Deaths = Totalt_antal_avlidna
  ) %>% 
    dplyr::mutate(
    Sex = case_when(Sex == "Man" ~ "m",
                    Sex == "Kvinna" ~ "f",
                    Sex == "Uppgift saknas" ~ "UNK"),
    Age = "TOT"
  ) %>% 
  dplyr::select(Sex, Age, Cases, Deaths)



  db_age <- read_excel(file_path,
                     sheet = 6) %>%
  dplyr::rename(
    Cases = Totalt_antal_fall,
    Deaths = Totalt_antal_avlidna
    , Age = ends_with("ldersgrupp")
  ) %>% 
  dplyr::mutate(
    Age = str_sub(Age, 7, 8),
    Age = case_when(Age == "0_" ~ "0",
                    Age == "t " ~ "UNK",
                    TRUE ~ Age),
    Sex = "b"
  ) %>% 
  dplyr::select(Sex, Age, Cases, Deaths)


  out_cases <- bind_rows(db_sex, db_age) %>% 
  gather(Cases, Deaths, key = Measure, value = Value) %>% 
  mutate(Country = "Sweden",
         Region = "All",
         Code = paste0("SE"),
         Date = date,
         AgeInt = case_when(
           Age == "TOT" | Age == "UNK" ~ NA_integer_
           , Age == "90" ~ 15L
           , TRUE ~ 10L
         ), Metric = "Count"
  ) %>% 
  select(Country, Region, Code, Date, Sex, Age, AgeInt, Metric, Measure, Value)

  .GlobalEnv$out_cases <- out_cases

}


for (i in epi_files) {
  print(paste("Adding lost epi-data for:", i))
  epi_gaps(file_path = i)
  lost_epidates <- rbind(lost_epidates, out_cases)
}


## END - EPI-DATA =====================================

## 2. Vax-data ====================

## load the xlsx files after unzipping and do some checks... 

vax.list <-list.files(path= paste0(dir_n, "29-06-25-07/Vaccinations/"), 
                      pattern = ".xlsx",
                      full.names = TRUE)


vax.list <- setNames(vax.list, vax.list) # only needed when you need an id-column with the file-names

## read the excel sheet that has the date, to extract the date of the data:
## function to do so

extract_date <- function(file_path){
  date_f_vac_temp <- excel_sheets(file_path)
  date_f_vac_temp <- date_f_vac_temp[grepl("[0-9]{4}$", date_f_vac_temp)]
  date_f_vac_temp <- trimws(gsub("FOHM", "", date_f_vac_temp))
}



vax_Sourcedates <- map_dfr(vax.list, extract_date) %>% 
  pivot_longer(cols = everything(),
               names_to = "file_name",
               values_to = "date")




vax_lastdate <- vax_Sourcedates %>% 
  mutate(date = str_replace_all(date, "MAJ", "May"),
         date = str_replace_all(date, "OKT", "Oct"),
         date = str_replace_all(date, "211028", "28 Oct 2021"),
         date = parse_date_time(date,
                                orders = "d m y")) 



unique_dates_vax <- Sweden %>% 
  filter(!Measure %in% c("Cases", "Deaths")) %>% 
  distinct(Date)



to_retrieve_vax <- vax_lastdate %>% 
  anti_join(unique_dates_vax, by = c("date" = "Date")) %>% 
  distinct(date, .keep_all = TRUE) 

vax_files <- to_retrieve_vax %>% 
  dplyr::pull(file_name)



## build a dataframe that has the corresponding sheets for sex and age #

to_retrieve_vax <- to_retrieve_vax %>% 
  mutate(sex_sheet = case_when(date < "2021-12-23" ~ "4",
                               date >= "2021-12-23" & date < "2022-01-27" ~ "5",
                               date >= "2022-01-27" & date < "2022-03-24" ~ "6",
                               date >= "2022-03-24" & date < "2022-03-30" ~ "7",
                               date > "2022-03-30" & date < "2022-06-23" ~ "8",
                               date > "2022-06-23" ~ "7"),
         sex_sheet = as.integer(sex_sheet),
         age_sheet = case_when(date < "2021-12-23" ~ "3",
                               date >= "2021-12-23" & date < "2022-01-27" ~ "3, 4",
                               date >= "2022-01-27" & date < "2022-03-24" ~ "4, 5",
                               date >= "2022-03-24" & date < "2022-03-30" ~ "4, 5, 6",
                               date > "2022-03-30" & date < "2022-06-23" ~ "5, 6, 7",
                               date >= "2022-06-23" ~ "5, 6")) 



## TWO-OBJECTS iteration from this dataframe to avoid multiple loops ##

## 2.1. Vax by Sex =======

out_sex <- to_retrieve_vax %>% 
  {map2_df(.$file_name, .$sex_sheet, ~ read_excel(path = .x, sheet = .y) %>% 
             mutate(id = .x))} %>% 
  left_join(to_retrieve_vax, by = c("id" = "file_name"))

## Transformation, management 


db_sex <- out_sex %>% 
  mutate(Vaccinationsstatus = coalesce(Dosnummer, Vaccinationsstatus)) %>% 
  select(Date = date,
         Sex = starts_with("K"),
         Value = contains("antal"), 
         Measure = contains("status")) %>% 
  mutate(Sex = case_when(str_detect(Sex, "M") ~ "m",
                         str_detect(Sex, "Kv") ~ "f",
                         str_detect(Sex, "Tot") ~ "TOT"),
         Measure = case_when(Measure %in% c("1",
                                            "Dos 1",
                                            "Minst 1 dos") ~ "Vaccination1",
                             Measure %in% c("2", 
                                            "Minst 2 doser",
                                            "2 doser",
                                            "Dos 2",
                                            "Färdigvaccinerade") ~ "Vaccination2",
                             Measure %in% c("Minst 3 doser") ~ "Vaccination3",
                             Measure %in% c("4 doser") ~ "Vaccination4"), 
         Age = "TOT",
         AgeInt = ""
         # Add empty row for UNK
         , Sex = ifelse(is.na(Sex), "UNK", Sex)
         , AgeInt = ifelse(Sex == "UNK", "", AgeInt)
         , Value = ifelse(Sex == "UNK", 0, Value),
         AgeInt = as.integer(AgeInt)
  ) %>%
  select(Sex, Date, Age, AgeInt, Measure, Value) %>%
  arrange(Sex)



## 2.2. Vax by Age =======

vax_age <- to_retrieve_vax %>% 
  tidyr::separate_rows(age_sheet, sep = ", ") %>% 
  dplyr::mutate(age_sheet = as.integer(age_sheet))


out_age <- vax_age %>% 
  {map2_df(.$file_name, .$age_sheet, ~ read_excel(path = .x, sheet = .y) %>% 
             mutate(id = .x))} %>% 
  dplyr::left_join(to_retrieve_vax, by = c("id" = "file_name")) %>% 
  dplyr::mutate(Vaccinationsstatus = coalesce(Dosnummer, Vaccinationsstatus))


db_age <- out_age %>%
  dplyr::filter(Region %in% "| Sverige |") %>% 
  dplyr::select(Date = date,
                Value = contains("antal"), 
                Measure = ends_with("status"),
                Age = ends_with("ldersgrupp")) %>% 
  dplyr::mutate(Measure = case_when(Measure %in% c("1",
                                                   "Dos 1",
                                                   "1 dos",
                                                   "Minst 1 dos") ~ "Vaccination1",
                                    Measure %in% c("2", 
                                                   "Minst 2 doser",
                                                   "2 doser",
                                                   "Dos 2",
                                                   "Färdigvaccinerade") ~ "Vaccination2",
                                    Measure %in% c("Minst 3 doser", "3 doser") ~ "Vaccination3",
                                    Measure %in% c("4 doser") ~ "Vaccination4"),
                Age = case_when(Age == "Totalt" ~ "TOT",
                                TRUE ~ Age),
                Age_low = as.numeric(str_extract(Age, "^[0-9]{2}")),
                Age_high = as.numeric(str_extract(Age, "[0-9]{2}$")),
                Age = as.character(Age_low),
                Age = ifelse(is.na(Age), "UNK", Age),
                ## would be good if one ot the team review this,
                ## I am not sure this is correct :(
                AgeInt = case_when(Age == "5" ~ 5L,
                                   Age == "90" ~ 15L,
                                   Age == "UNK" ~ NA_integer_,
                                   TRUE ~ 10L),
                Sex = "b",
                Value = ifelse(Age == "UNK", 0, Value)) %>%
  dplyr::select(Date, Sex, Age, AgeInt, Measure, Value)



## Append to main dataset (.rds file) ## ==========================


Sweden_appended <- bind_rows(Sweden, 
                             lost_epidates
                             #,db_sex, db_age
                             ) %>%
  dplyr::mutate(
        Country = "Sweden",
         Region = "All",
         Date = ddmmyyyy(Date),
         Code = paste0("SE"), 
         Metric = "Count") %>% 
  dplyr::select(Country, Region, Code, Date, Sex, Age, AgeInt, Metric, Measure, Value) %>% 
  sort_input_data()


write_rds(Sweden_appended, paste0(dir_n, ctr, ".rds"))



```


##├ Date: 24.10.2022
Problem: Sweden Vaccination data have issue in dates; that usually result in duplicates! 
for the period between 10.08.2022 and 21.09.2022, inclusive 

```{r eval=FALSE, include=FALSE}

# info country and N drive address
ctr <- "Sweden"
dir_n <- "N:/COVerAGE-DB/Automation/Hydra/Data_sources/Sweden/Vaccination-10082022-21092022/"


## read in the latest .rds file 

Sweden_drive <- readRDS("N:/COVerAGE-DB/Automation/Hydra/Sweden.rds") %>% 
  filter(str_detect(Measure, "Vaccin"))




vax.list <-list.files(path= dir_n, 
                      pattern = ".xlsx",
                      full.names = TRUE)


vax.list <- setNames(vax.list, vax.list) # only needed when you need an id-column with the file-names

## read the excel sheet that has the date, to extract the date of the data:
## function to do so

extract_date <- function(file_path){
  date_f_vac_temp <- excel_sheets(file_path)
  date_f_vac_temp <- date_f_vac_temp[grepl("[0-9]{4}$", date_f_vac_temp)]
  date_f_vac_temp <- trimws(gsub("FOHM", "", date_f_vac_temp))
}



vax_Sourcedates <- map_dfr(vax.list, extract_date) %>% 
  pivot_longer(cols = everything(),
               names_to = "file_name",
               values_to = "date") 
  




vax_lastdate <- vax_Sourcedates %>% 
  mutate(date = str_replace_all(date, "MAJ", "May"),
         date = str_replace_all(date, "OKT", "Oct"),
         date = str_replace_all(date, "211028", "28 Oct 2021"),
         date = parse_date_time(date,
                                orders = "d m y"),
         sex_sheet = "Vaccinerade kön",
         vacc_1_3 = "Dos 1 till 3 per åldersgrupp",
         vacc_4 = "Dos 4 per åldersgrupp",
         vacc_5 = "Dos 5 per åldersgrupp") 


dates <- vax_lastdate %>% 
  select(file_name, date)



## TWO-OBJECTS iteration from this dataframe to avoid multiple loops ##

## 2.1. Vax by Sex =======

db_sex <- vax_lastdate %>% 
  {map2_df(.$file_name, .$sex_sheet, ~ read_excel(path = .x, sheet = .y) %>% 
             mutate(id = .x))} %>% 
  left_join(dates, by = c("id" = "file_name"))




out_sex <- db_sex %>% 
  select(Date = date,
         Sex = starts_with("K"),
         Value = contains("antal"), 
         Measure = contains("status")) %>% 
  mutate(Sex = case_when(str_detect(Sex, "M") ~ "m",
                         str_detect(Sex, "Kv") ~ "f",
                         str_detect(Sex, "Tot") ~ "b"),
         Measure = case_when(Measure %in% c("1",
                                            "Dos 1",
                                            "Minst 1 dos") ~ "Vaccination1",
                             Measure %in% c("2", 
                                            "Minst 2 doser",
                                            "2 doser",
                                            "Dos 2",
                                            "Färdigvaccinerade") ~ "Vaccination2",
                             Measure %in% c("Minst 3 doser") ~ "Vaccination3",
                             Measure %in% c("4 doser") ~ "Vaccination4"), 
         Age = "TOT",
         AgeInt = ""
         # Add empty row for UNK
         , Sex = ifelse(is.na(Sex), "UNK", Sex)
         , AgeInt = ifelse(Sex == "UNK", "", AgeInt)
         , Value = ifelse(Sex == "UNK", 0, Value),
         AgeInt = as.integer(AgeInt)
  ) %>%
  select(Sex, Date, Age, AgeInt, Measure, Value) %>%
  arrange(Sex)



## 2.2. Vax by Age =======


vaccage_1 <- vax_lastdate %>% 
  {map2_df(.$file_name, .$vacc_1_3, ~ read_excel(path = .x, sheet = .y) %>% 
             mutate(id = .x))} %>% 
  dplyr::left_join(dates, by = c("id" = "file_name")) 


vaccage_4 <- vax_lastdate %>% 
  {map2_df(.$file_name, .$vacc_4, ~ read_excel(path = .x, sheet = .y) %>% 
             mutate(id = .x))} %>% 
  dplyr::left_join(dates, by = c("id" = "file_name")) 



vaccage_5 <- vax_lastdate %>% 
  filter(!str_detect(date, "2022-09-15")) %>% 
  {map2_df(.$file_name, .$vacc_5, ~ read_excel(path = .x, sheet = .y) %>% 
             mutate(id = .x))} %>% 
  dplyr::left_join(dates, by = c("id" = "file_name")) 




db_age <- bind_rows(vaccage_1, vaccage_4, vaccage_5)



out_age <- db_age %>%
  dplyr::filter(Region %in% "| Sverige |") %>% 
  dplyr::select(Date = date,
                Value = contains("antal"), 
                Measure = ends_with("status"),
                Age = ends_with("ldersgrupp")) %>% 
  dplyr::filter(!str_detect(Age, "Totalt 18+")) %>% 
  dplyr::mutate(Measure = case_when(Measure %in% c("1",
                                                   "Dos 1",
                                                   "1 dos",
                                                   "Minst 1 dos") ~ "Vaccination1",
                                    Measure %in% c("2", 
                                                   "Minst 2 doser",
                                                   "2 doser",
                                                   "Dos 2",
                                                   "Färdigvaccinerade") ~ "Vaccination2",
                                    Measure %in% c("Minst 3 doser", "3 doser") ~ "Vaccination3",
                                    Measure %in% c("4 doser") ~ "Vaccination4",
                                    Measure %in% c("5 doser") ~ "Vaccination5"),
                Age = case_when(Age == "Totalt" ~ "TOT",
                                TRUE ~ str_extract(Age, "^[0-9]{2}")),
                # Age_low = as.numeric(str_extract(Age, "^[0-9]{2}")),
                # Age_high = as.numeric(str_extract(Age, "[0-9]{2}$")),
                Age = as.character(Age),
              #  Age = ifelse(is.na(Age), "UNK", Age),
                AgeInt = case_when(Age == "12" ~ 4L,
                                   Age == "16" ~ 2L,
                                   Age == "18" ~ 12L,
                                   Age == "90" ~ 15L,
                               #    Age == "UNK" ~ NA_integer_,
                                   TRUE ~ 10L),
                Sex = "b"
               # Value = ifelse(Age == "UNK", 0, Value)
                ) %>%
  dplyr::select(Date, Sex, Age, AgeInt, Measure, Value)



all_vax <- bind_rows(out_age, out_sex) %>% 
  dplyr::mutate(
        Country = "Sweden",
         Region = "All",
        Date = ddmmyyyy(Date),
         Code = paste0("SE"),
        AgeInt = as.character(AgeInt),
         Metric = "Count")


## Append to main dataset (.rds file) ## ==========================

df_tofilter <- Sweden_drive %>% 
  mutate(Date = dmy(Date)) %>% 
  filter(Date >= "2022-08-10", 
         Date <= "2022-09-21") %>% 
  distinct(Date)

df_filtered <- Sweden_drive %>% 
  mutate(Date = dmy(Date)) %>% 
  anti_join(df_tofilter, by = c("Date" = "Date")) %>% 
  mutate(Date = ddmmyyyy(Date))



Sweden_appended <- bind_rows(df_filtered, 
                             all_vax) %>%
  dplyr::select(Country, Region, Code, Date, Sex, Age, AgeInt, Metric, Measure, Value) %>% 
  sort_input_data()


write_rds(Sweden_appended, paste0(dir_n, "SwedenVax", ".rds"))





```



































## South Africa PDFs into dataframe! 
## FAILED :( ##

```{r}

# info country and N drive address
ctr          <- "SouthAfrica" # it's a placeholder
dir_n        <- "N:/COVerAGE-DB/Automation/Hydra/"

## The purpose of this script is to download the PDFs from the GAMBIA website.
## Not for automation though. 
## and so we may run this script once a month to download the PDFs. 


files_source <- paste0(dir_n, "Data_sources/", ctr, "/")

text_table <- function(pdf_file){
  
  pdf_text(pdf_file) %>% 
    read_lines() %>% 
    .[338:356] %>% 
    str_trim() %>% 
    str_replace_all("\\s{2,}", "|") %>% 
    str_remove_all(",") %>% 
    as_tibble() %>% 
    tidyr::separate(col = value, into = c("Age", "Cases", "X1", "X2", "X3", "X4"), sep = "\\|")
  
}

pdf_table <- list.files(path = files_source,
           pattern = ".pdf",
           full.names = TRUE) %>% data.frame(x = .)

pdf <- pdf_table %>% 
  filter(str_detect(x, "-2022.pdf")) %>% 
  mutate(week = str_extract(x, "\\d+-2022"),
         weeknumber = str_extract(week, "\\d+"),
         weeknumber = as.numeric(weeknumber)) %>% 
  filter(weeknumber > 7) %>% 
  select(x) %>% 
  dplyr::pull()

pdf %>% 
  purrr::map_dfr(text_table, .id = "file_name") %>%
  mutate(file_name = basename(file_name)) %>% # ADD BASENAME TO DF 
  View()







```




















































































































## ================== LENGHTY NON-SENSE LOOPS ================ ##

ANOTHER METHOD OF WORK ========

Functions to go over the missing data files and append first separately from the main dataset 

After reviewing the sheets manually: 
** from 02.02.2021, sex was in sheet 4, age in sheet 3
** from 23.12.2021, sex was in sheet 5, age in sheet 3, 4 depending on the # of doses
** from 27.01.2022, sex was in sheet 6, age in sheet 4, 5 depending on the # of doses
** from 25.03.2022, sex was in sheet 7, age in sheet 4, 5, 6 depending on the # of doses
** from 01.04.2022, sex was in sheet 8, age in sheet 5,6,7 depending on the # of doses
** from 24.06.2022, sex was in sheet 7, age in sheet 5,6 depending on the # of doses



```{r eval=FALSE, include=FALSE}
 

before_24Dec <- to_retrieve_vax %>%
  filter(date < "2021-12-23") %>%
  dplyr::pull(file_name)



After_24Dec <- to_retrieve_vax %>%
  filter(date > "2021-12-23", date < "2022-01-27") %>%
  dplyr::pull(file_name)



After_27Jan <- to_retrieve_vax %>%
  filter(date >= "2022-01-27", date < "2022-03-24") %>%
  dplyr::pull(file_name)




After_25Mar <- to_retrieve_vax %>%
  filter(date > "2022-03-24", date < "2022-03-30") %>%
  dplyr::pull(file_name)



After_Apr <- to_retrieve_vax %>%
  filter(date > "2022-03-30", date < "2022-06-23") %>%
  dplyr::pull(file_name)



After_lateJune <- to_retrieve_vax %>%
  filter(date > "2022-06-23") %>%
  dplyr::pull(file_name)


##### FUNCTION ##### ===============


vax_sex_data <- data.frame()

fill_dates_sex <- function(file_path, sex_sheet) {

  date <- to_retrieve_vax %>%
    dplyr::filter(stringr::str_detect(file_name, pattern = file_path)) %>%
    dplyr::pull(date)


  db_sex <- read_excel(file_path,
                       sheet = sex_sheet) %>%
    select(Sex = starts_with("K"),
           Value = contains("antal"),
           Measure = contains(c("Dosnummer", "status"))) %>%
    mutate(Sex = case_when(str_detect(Sex, "M") ~ "m",
                           str_detect(Sex, "Kv") ~ "f",
                           str_detect(Sex, "Tot") ~ "TOT"),
           Measure = case_when(Measure %in% c("1",
                                              "Dos 1",
                                              "Minst 1 dos") ~ "Vaccination1",
                               Measure %in% c("2",
                                              "Minst 2 doser",
                                              "2 doser",
                                              "Dos 2",
                                              "Färdigvaccinerade") ~ "Vaccination2",
                               Measure %in% c("Minst 3 doser") ~ "Vaccination3",
                               Measure %in% c("4 doser") ~ "Vaccination4"),
           Age = "TOT",
           AgeInt = ""
           # Add empty row for UNK
           , Sex = ifelse(is.na(Sex), "UNK", Sex)
           , AgeInt = ifelse(Sex == "UNK", "", AgeInt)
           , Value = ifelse(Sex == "UNK", 0, Value)
           , Date = date
    ) %>%
    select(Sex, Date, Age, AgeInt, Measure, Value) %>%
    arrange(Sex)

  .GlobalEnv$db_sex <- db_sex
}



for (file in before_24Dec) {
  print(paste("Adding lost Vax sex for:", file))
  fill_dates_sex(file_path = file, sex_sheet = 4)
  vax_sex_data <- rbind(vax_sex_data, db_sex)

}


for (file in After_24Dec) {
  print(paste("Adding lost Vax sex for:", file))
  fill_dates_sex(file_path = file, sex_sheet = 5)
  vax_sex_data <- rbind(vax_sex_data, db_sex)

}


for (file in After_27Jan) {
  print(paste("Adding lost Vax sex for:", file))
  fill_dates_sex(file_path = file, sex_sheet = 6)
  vax_sex_data <- rbind(vax_sex_data, db_sex)

}


for (file in After_25Mar) {
  print(paste("Adding lost Vax sex for:", file))
  fill_dates_sex(file_path = file, sex_sheet =7)
  vax_sex_data <- rbind(vax_sex_data, db_sex)

}



for (file in After_Apr) {
  print(paste("Adding lost Vax sex for:", file))
  fill_dates_sex(file_path = file, sex_sheet = 8)
  vax_sex_data <- rbind(vax_sex_data, db_sex)

}


for (file in After_lateJune) {
  print(paste("Adding lost Vax sex for:", file))
  fill_dates_sex(file_path = file, sex_sheet = 7)
  vax_sex_data <- rbind(vax_sex_data, db_sex)

}


## Check on this horrible loop!
## all data are added if this result in 0 obs.
vax_sex_data %>%
  distinct(Date) %>%
  anti_join(to_retrieve_vax, by = c("Date" = "date"))


```



# Romania

##├ 11.10.2022

downlaoding html pages links for deaths data 

```{r}
# load packages 
library(tidyverse)
library(rvest)


url_main <- "https://covid19.stirioficiale.ro/informatii"


data.frame(links = read_html(url_text) %>% 
             html_nodes("a ") %>% 
             html_attr('href')) 

## extract links in multiple pages 

url_loop <- "https://covid19.stirioficiale.ro/informatii?page="

pages <- seq(1:179)

all_links <- data.frame()

for (i in pages) {
  df_links <- data.frame(links = read_html(paste0(url_loop, i)) %>% 
               html_nodes("a ") %>% 
               html_attr('href'))
  all_links <- rbind(all_links, df_links)
}


covid_links <- all_links %>% 
  filter(str_detect(links, "buletin-de-presa")) %>% 
  distinct()

covid_links %>% write.csv("links.csv")
```


##├ 26.10.2022

## The data collected manually have missing new cases & new deaths for the days: 04.07.2021 & 21.10.2021, respectively. IN order not to lose the series, and since we had the cumulative for both days, I calculated the new cases in these missing dates as a fraction from the preceeding respective dates. Though it is limitation (given it is one day fraction not a week, for example), I think it is reasonable to consider the calulcation as such. 

```{r}


# info country and N drive address
ctr     <- "Romania" # it's a placeholder
ctr_deaths <- "Romania/MissingData_June2022"
dir_n   <- "N:/COVerAGE-DB/Automation/Hydra/"


# Drive credentials
drive_auth(email = Sys.getenv("email"))
gs4_auth(email = Sys.getenv("email"))


files_path <- list.files(
  path= paste0(dir_n, "Data_sources/", ctr_deaths),
  pattern = ".xlsx",
  full.names = TRUE) %>% 
  data.frame(files = .)


deaths_path <- files_path %>% 
  filter(str_detect(files, "deaths")) %>% 
  dplyr::pull(files)

cases_path <- files_path %>% 
  filter(str_detect(files, "Cases")) %>% 
  dplyr::pull(files)
  
deaths_df <- read_excel(deaths_path, sheet = "Deaths")

deaths_total <- deaths_df %>% 
  filter(Age == "TOT",
         !Sex %in% c("f", "m")) %>% 
  pivot_longer(cols = -c("Sex", "Age", "Measure"),
               names_to = "date_prep",
               values_to = "value") %>% 
  mutate(date_prep = format(as.Date(as.numeric(date_prep), origin = "1899-12-30"), "%Y-%m-%d"))


deaths_age <- deaths_df %>% 
  filter(Measure == "Deaths" & Age != "TOT")


deaths_sex <- deaths_df %>% 
  filter(Measure == "Deaths" & Sex %in% c("f", "m"))

deaths_new <- bind_rows(deaths_age, deaths_sex) %>% 
  mutate(across(.cols = -c("Sex", "Age", "Measure"),
                .fns = ~ replace_na(.x, 0))) %>% 
  pivot_longer(cols = -c("Sex", "Age", "Measure"),
               names_to = "date_prep",
               values_to = "Value") %>% 
  mutate(date_prep = format(as.Date(as.numeric(date_prep), origin = "1899-12-30"), "%Y-%m-%d")) %>%
  arrange(date_prep) %>% 
  group_by(Sex, Age) %>% 
  mutate(value = cumsum(Value),
         Measure == "Deaths") %>% 
  ungroup() %>% 
  select(Age, Sex, date_prep, value, Measure) 
#  pivot_wider(names_from = date_prep, values_from = value)
  # mutate(across(.cols = -c("Sex", "Age", "Measure"),
  #               .fns = ~ cumsum(.x)))

# deaths_new %>% 
#   filter(date_prep %in% c("10-06-2020", "11-06-2020")) %>% View()


deaths_out <- bind_rows(deaths_new, deaths_total) %>% 
  select(Age, Sex, Date = date_prep, Value = value, Measure) %>% 
  mutate(Age = as.character(Age),
         Date = ddmmyyyy(Date))

## to continue when Larbi share the data == Cases

cases_df <- read_excel(cases_path, sheet = "database")

prep_out <- function(tbl){
  tbl %>% 
  arrange(Date) %>% 
  group_by(Sex, Age) %>% 
  mutate(value = cumsum(Value),
         Measure == "Cases") %>% 
  ungroup() %>% 
  select(Age, Sex, Date, value, Measure) 
}


cases_df_out <- cases_df %>% 
  prep_out() %>% 
  mutate(Age = as.character(Age),
         Date = ddmmyyyy(Date)) %>% 
  select(Age, Sex, Date, Value = value, Measure)
  

romania_out <- bind_rows(cases_df_out, deaths_out) %>% 
  mutate(Metric = "Count",
         Country = "Romania",
         Region = "All",
         Code = "RO",
         AgeInt = case_when(Age == "80" ~ 25L,
                            TRUE ~ 10L)) %>% 
  sort_input_data()


## read pre 10.06.2020 from the drive 



at_rubric <- get_input_rubric() %>% 
  dplyr::filter(Short == "RO")
ss_i   <- at_rubric %>% dplyr::pull(Sheet)
ss_db  <- at_rubric %>% dplyr::pull(Source)


db_drive <- read_sheet(ss = ss_i, sheet = "pre-June-2020") %>% 
  mutate(Value = as.numeric(Value))


Out <- bind_rows(db_drive, romania_out) %>% 
  sort_input_data()

sheet_write(Out, ss = ss_i, sheet = "database")


```






















